# ğŸ“ IELTS Tutor RAG Agent (åŸºäº Qwen2.5-7B çš„é›…æ€æ™ºèƒ½åŠ©æ•™)

> **An Advanced RAG Agent for IELTS Preparation running locally.**
>
> ä¸€ä¸ªåŸºäº Qwen2.5-7Bã€LangGraph å’Œæ··åˆæ£€ç´¢æŠ€æœ¯æ„å»ºçš„å…·å¤‡è‡ªæˆ‘åæ€ä¸æ£€ç´¢ä¼˜åŒ–èƒ½åŠ›çš„æœ¬åœ°åŒ–é›…æ€å¤‡è€ƒåŠ©æ‰‹ã€‚å®ç°äº†ä½èµ„æºä¸‹çš„ Agentic RAGã€‚

## ğŸ’¡ ä¸ºä»€ä¹ˆåšè¿™ä¸ªé¡¹ç›®ï¼Ÿ

foræ­£åœ¨å¤‡è€ƒé›…æ€çš„å­¦ç”Ÿï¼Œé€šç”¨å¤§æ¨¡å‹åœ¨å›ç­”å…·ä½“çš„è¯„åˆ†æ ‡å‡†ï¼ˆå¦‚ Band Descriptorsï¼‰æ—¶ç»å¸¸äº§ç”Ÿå¹»è§‰ï¼Œæ— æ³•å…·å¤‡é’ˆå¯¹æ€§çš„æå‡ºæ‰¹æ”¹å»ºè®®è¿›è¡Œä¼˜åŒ–ã€‚é€šè¿‡æ„å»ºè¿™ä¸ª RAG ç³»ç»Ÿï¼Œæˆ‘ä¸ä»…æ·±å…¥å®è·µäº† Retrieval-Augmented Generation å’Œ Agentic AI çš„ç”¨æ³•ï¼Œå¹¶ä¸”å®ç°åœ¨æœ‰é™ç®—åŠ›ä¸‹çš„æ€§èƒ½ä¼˜åŒ–ã€‚ï¼ˆå°†LLMç»™GPU,embeddingã€rerankerç»™CPUï¼Œå®ç°åœ¨3060-6Gä¸‹è·‘é€š7Bæ¨¡å‹ï¼‰

* **ä¼ ç»Ÿ RAG**ï¼šæ£€ç´¢ -> ç”Ÿæˆ -> ç»“æŸï¼Œæ˜¯ä¸€æ¡ç›´çº¿ã€‚
* **ç›®æ ‡Agent**ï¼šæ£€ç´¢ -> ç”Ÿæˆ -> æ£€æŸ¥ -> å‘ç°ä¸å¯¹ -> æ”¹å†™é—®é¢˜ -> é‡æ–°æ£€ç´¢ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ†ç¯ã€‚

## ğŸ“– é¡¹ç›®ç®€ä»‹ (Introduction)

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªä½æˆæœ¬ã€é«˜éšç§ã€ä¸“ä¸šåŒ–çš„é›…æ€åŠ©æ•™ã€‚é¡¹ç›®åŸºäº Ollama æœ¬åœ°éƒ¨ç½²çš„ Qwen2.5-7B æ¨¡å‹ï¼Œç»å†äº†ä»â€œåŸºç¡€ RAGâ€åˆ°â€œé«˜çº§ Agentâ€çš„è¿­ä»£å¼€å‘ã€‚

ä¸ä»…å®ç°äº†åŸºäºæ–‡æ¡£çš„çŸ¥è¯†é—®ç­”ï¼Œæ›´å¼•å…¥äº† LangGraph çŠ¶æ€æœºï¼Œä½¿æ¨¡å‹å…·å¤‡äº†è‡ªæˆ‘åæ€å’ŒæŸ¥è¯¢æ”¹å†™çš„èƒ½åŠ›ï¼Œæœ‰æ•ˆè§£å†³äº†ä¼ ç»Ÿ RAG ç³»ç»Ÿä¸­â€œæ£€ç´¢ä¸ç²¾å‡†â€å’Œâ€œå›ç­”å¹»è§‰â€çš„ç—›ç‚¹ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„æ¼”è¿› (Architecture Evolution)

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºçº¿ç³»ç»Ÿ (Baseline RAG) `ragchat.py`

æœ€åˆæ­å»ºäº†ä¸€ä¸ªåŸºäº LangChain + ChromaDB çš„æ ‡å‡†çº¿æ€§ RAG ç³»ç»Ÿã€‚

* **çº¿æ€§æµç¨‹ (Linear Pipeline)**: éµå¾ª Retrieve (æ£€ç´¢) -> Augment (å¢å¼º) -> Generate (ç”Ÿæˆ) çš„æ ‡å‡†èŒƒå¼ã€‚
* **Prompt å·¥ç¨‹ä¼˜åŒ–**: é’ˆå¯¹åŸºçº¿æ¨¡å‹å›ç­”æ­»æ¿çš„é—®é¢˜ï¼Œè®¾è®¡äº† â€œæ··åˆæ¨¡å¼â€ (Hybrid Mode) Promptã€‚
    * ç³»ç»Ÿèƒ½åŠ¨æ€åˆ¤æ–­ç”¨æˆ·æ„å›¾ï¼šå¦‚æœæ˜¯é—²èŠï¼Œä½¿ç”¨æ¨¡å‹å†…ç”ŸçŸ¥è¯†ï¼ˆInternal Knowledgeï¼‰ï¼›å¦‚æœæ˜¯ä¸“ä¸šé—®é¢˜ï¼Œå¼ºåˆ¶åŸºäºå¤–éƒ¨çŸ¥è¯†åº“ï¼ˆExternal Knowledgeï¼‰å›ç­”ã€‚
* **å‘é‡æ£€ç´¢**: ä½¿ç”¨ ChromaDB è¿›è¡Œä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰æœç´¢ï¼Œå¬å› Top-3 ç›¸å…³æ–‡æ¡£ã€‚

### ç¬¬äºŒé˜¶æ®µï¼šAdvanced Agentic RAG `agent_rag.py`

é’ˆå¯¹åŸºçº¿ç‰ˆæœ¬ä¸­ä¸“æœ‰åè¯ä¸¢å¤±ä»¥åŠå›ç­”é€»è¾‘å•ä¸€çš„é—®é¢˜ï¼Œå¼•å…¥äº† Agentic Workflow è¿›è¡Œé‡æ„ã€‚

#### 1. æ£€ç´¢å¢å¼º (Advanced Retrieval)
ä¸ºäº†è§£å†³çº¯å‘é‡æ£€ç´¢çš„å±€é™æ€§ï¼Œæ„å»ºäº†å¤šè·¯å¬å›ä¸ç²¾æ’æœºåˆ¶ï¼š

* **æ··åˆæ£€ç´¢ (Hybrid Search)**:
    * **BM25**: è´Ÿè´£å…³é”®è¯åŒ¹é…ï¼Œè§£å†³â€œé›…æ€ç‰¹å®šæœ¯è¯­ï¼ˆå¦‚ TR, GRA, Task 1ï¼‰â€åœ¨çº¯è¯­ä¹‰ç©ºé—´ä¸­å®¹æ˜“è¢«å¿½ç•¥çš„é—®é¢˜ã€‚
    * **Vector Search**: è´Ÿè´£è¯­ä¹‰åŒ¹é…ï¼Œç†è§£ç”¨æˆ·é—®é¢˜çš„æ·±å±‚å«ä¹‰ã€‚
    * é€šè¿‡ `EnsembleRetriever` å¯¹ä¸¤è€…ç»“æœè¿›è¡ŒåŠ æƒèåˆã€‚
* **é‡æ’åº (Re-ranking)**:
    * å¼•å…¥ Cross-Encoder æ¨¡å‹ï¼ˆbge-rerankerï¼‰ï¼Œåƒâ€œé˜…å·è€å¸ˆâ€ä¸€æ ·å¯¹å¬å›çš„æ–‡æ¡£è¿›è¡Œç»†ç²’åº¦æ‰“åˆ†ã€‚
    * è¿‡æ»¤æ‰ç›¸å…³æ€§ä½çš„å™ªéŸ³æ–‡æ¡£ï¼Œä»…ä¿ç•™ Top-3 é«˜ç½®ä¿¡åº¦ç‰‡æ®µç»™å¤§æ¨¡å‹ï¼Œå¤§å¹…å‡å°‘å¹»è§‰ã€‚

#### 2. æ™ºèƒ½ä½“å·¥ä½œæµ (Agentic Workflow with LangGraph)
æ”¾å¼ƒäº†å•å‘é“¾æ¡ï¼Œä½¿ç”¨ LangGraph æ„å»ºäº†ä¸€ä¸ªæœ‰ç¯å›¾ (Cyclic Graph) çŠ¶æ€æœºï¼š

* **è‡ªæˆ‘åæ€ (Self-Reflection)**: æ¨¡å‹ç”Ÿæˆç­”æ¡ˆåï¼Œä¼šè§¦å‘ Hallucination Check èŠ‚ç‚¹ï¼Œè‡ªæŸ¥â€œæˆ‘çš„å›ç­”æ˜¯å¦æœ‰æ–‡æ¡£ä¾æ®ï¼Ÿâ€
* **æŸ¥è¯¢æ”¹å†™ (Query Rewriting)**: å¦‚æœè‡ªæŸ¥ä¸é€šè¿‡ï¼Œç³»ç»Ÿä¸ä¼šè¾“å‡ºé”™è¯¯ç­”æ¡ˆï¼Œè€Œæ˜¯è¿›å…¥ Rewrite èŠ‚ç‚¹ã€‚LLM ä¼šå°†ç”¨æˆ·æ¨¡ç³Šçš„è¾“å…¥ä¼˜åŒ–ä¸ºæ›´é€‚åˆæ£€ç´¢çš„ä¸“ä¸šæé—®ï¼ˆQuery Optimizationï¼‰ï¼Œå¹¶è‡ªåŠ¨è§¦å‘é‡è¯•ã€‚
* **é—­ç¯æœºåˆ¶**: `Retrieve -> Generate -> Reflect -> (Rewrite -> Retrieve)` çš„åŠ¨æ€å¾ªç¯ç¡®ä¿äº†å›ç­”çš„é«˜è´¨é‡ã€‚
* 
## ğŸ“Š è¯„ä¼°ä¸æ¶ˆèå®éªŒ (Evaluation & Ablation Study)

ä¸ºäº†éªŒè¯ç³»ç»Ÿçš„æœ‰æ•ˆæ€§ï¼Œæ„å»ºäº†ä¸€ä¸ªåŒ…å«é›…æ€é«˜é¢‘é—®é¢˜çš„ Golden Datasetï¼Œå¹¶ä½¿ç”¨Ragasæ¡†æ¶è¿›è¡Œäº†è‡ªåŠ¨åŒ–è¯„ä¼°ã€‚

æˆ‘ä»¬å¯¹æ¯”äº† **Baseline (ä»…å‘é‡æ£€ç´¢)** ä¸ **Advanced (æ··åˆæ£€ç´¢ + é‡æ’åº)** çš„æ€§èƒ½è¡¨ç°ï¼š

| Metric (æŒ‡æ ‡) | Baseline | **Advanced Agent (Ours)** | æå‡ (Improvement) |
| :--- | :---: | :---: | :---: |
| **Faithfulness (å¿ å®åº¦)** | 0.72 | **0.89** | ğŸ”º **+23.6%** |
| **Answer Relevancy (ç›¸å…³æ€§)** | 0.78 | **0.91** | ğŸ”º **+16.7%** |

> **è§£è¯»**: å¼•å…¥ Cross-Encoder é‡æ’åºåï¼Œæ¨¡å‹çš„å¹»è§‰å¤§å¹…å‡å°‘ (Faithfulness æå‡)ï¼Œè¯æ˜äº†â€œå…ˆç²—æ’åç²¾æ’â€ç­–ç•¥åœ¨é›…æ€çŸ¥è¯†é—®ç­”ä¸­çš„å¿…è¦æ€§ã€‚
> 
> ## ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šRedis ç¼“å­˜é›†æˆ (Performance Optimization)

ä¸ºäº†è§£å†³æœ¬åœ°å•å¡ (Single GPU) æ¨ç†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½ç“¶é¢ˆï¼Œæœ¬é¡¹ç›®å¼•å…¥äº† **Redis** ä½œä¸ºä¸€çº§ç¼“å­˜å±‚ã€‚

### 1. ç¼“å­˜æ¶æ„é€»è¾‘
* **æŒ‡çº¹ç”Ÿæˆ**ï¼šå¯¹ç”¨æˆ·è¾“å…¥çš„ `question` è¿›è¡Œ MD5 å“ˆå¸Œè®¡ç®—ï¼Œç”Ÿæˆå”¯ä¸€çš„ Cache Keyã€‚
* **Look-aside ç­–ç•¥**ï¼š
    * **Hit (å‘½ä¸­)**ï¼šå¦‚æœ Redis ä¸­å­˜åœ¨è¯¥ Keyï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„ JSON ç»“æœï¼Œè·³è¿‡ LLM æ¨ç†ï¼ˆå»¶è¿Ÿ < 10msï¼‰ã€‚
    * **Miss (æœªå‘½ä¸­)**ï¼šè°ƒç”¨ LangChain Agent è¿›è¡Œæ¨ç†ï¼Œå°†ç»“æœå­˜å…¥ Redis å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 1å°æ—¶ï¼‰ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ã€‚

### 2. å¯åŠ¨æ­¥éª¤
ç¡®ä¿ä½ å·²ç»å®‰è£…å¹¶å¯åŠ¨äº† Redis æœåŠ¡ (æ¨èä½¿ç”¨ Redis 5.0+ Windows ç‰ˆæœ¬)ã€‚

1.  **å¯åŠ¨ Redis æœåŠ¡ç«¯**ï¼š
    ```powershell
    # åœ¨ Redis å®‰è£…ç›®å½•ä¸‹è¿è¡Œ
    .\redis-server.exe --bind 127.0.0.1
    ```

2.  **å¯åŠ¨å¸¦æœ‰ç¼“å­˜åŠŸèƒ½çš„åç«¯**ï¼š
    ```powershell
    # ç¡®ä¿ Ollama æœåŠ¡ä¹Ÿåœ¨è¿è¡Œä¸­
    python server.py
    ```
    *(æ³¨ï¼šç¡®ä¿ server.py ä¸­å·²åŒ…å« Redis è¿æ¥é€»è¾‘)*

---

## ğŸ§ª å‹åŠ›æµ‹è¯•ä¸å®éªŒæŠ¥å‘Š (Load Testing & Benchmark)

æœ¬é¡¹ç›®ä½¿ç”¨ **Locust** è¿›è¡Œäº†ä¸¥æ ¼çš„è´Ÿè½½æµ‹è¯•ï¼Œä»¥éªŒè¯ç¼“å­˜æœºåˆ¶å¯¹ç³»ç»Ÿååé‡ï¼ˆRPSï¼‰å’Œå“åº”å»¶è¿Ÿï¼ˆLatencyï¼‰çš„ä¼˜åŒ–æ•ˆæœã€‚

### 1. æµ‹è¯•ç¯å¢ƒ
* **å·¥å…·**ï¼šLocust
* **æ¨¡æ‹Ÿè´Ÿè½½**ï¼š5 Users, Spawn Rate 1 (æ¨¡æ‹Ÿ 5 äººå¹¶å‘æé—®)
* **ç¡¬ä»¶é™åˆ¶**ï¼šæœ¬åœ°å• GPU (Local Single GPU Deployment)

### 2. è¿è¡Œæµ‹è¯•

å¯åŠ¨ Locust å‹æµ‹è„šæœ¬
locust -f locustfile.py --host http://localhost:8000


### 3. å®éªŒç»“æœå¯¹æ¯” (Before & After)

åŸºäº 900+ æ¬¡è¯·æ±‚çš„å‹æµ‹æ•°æ®å¯¹æ¯”åˆ†æï¼š

| æ ¸å¿ƒæŒ‡æ ‡ (Metrics) | ğŸ¢ æ— ç¼“å­˜ (Baseline) | âš¡ å¼€å¯ Redis ç¼“å­˜ (Optimized) | æå‡å¹…åº¦ |
| :--- | :--- | :--- | :--- |
| **ä¸­ä½æ•°å»¶è¿Ÿ (Median Latency)** | 61,000 ms (61ç§’) | **4 ms** | **ğŸš€ æå‡ 15,000 å€** |
| **å¹³å‡å»¶è¿Ÿ (Avg Latency)** | 63,330 ms | 5,925 ms | ğŸ“‰ é™ä½ 90% |
| **è¯·æ±‚å¤±è´¥ç‡ (Failure Rate)** | 39% (æ‹¥å µå¯¼è‡´è¶…æ—¶) | **2%** (ç³»ç»Ÿç¨³å®š) | âœ… æ˜¾è‘—æå‡å¯ç”¨æ€§ |
| **ååé‡ (RPS)** | ~0.0 | 0.8 | ğŸ“ˆ ååé‡å¤§å¢ |

> **ğŸ“Š å®éªŒç»“è®º**
>
> åœ¨é«˜å¹¶å‘é‡å¤æŸ¥è¯¢åœºæ™¯ä¸‹ï¼Œå¼•å…¥ Redis ç¼“å­˜å°†ç³»ç»Ÿä»â€œä¸å¯ç”¨çŠ¶æ€â€ï¼ˆé«˜å»¶è¿Ÿã€é«˜ä¸¢åŒ…ï¼‰è½¬å˜ä¸ºâ€œé«˜å¯ç”¨çŠ¶æ€â€ï¼ˆæ¯«ç§’çº§å“åº”ï¼‰ï¼Œæå¤§ç¼“è§£äº†æœ¬åœ°å¤§æ¨¡å‹çš„ç®—åŠ›ç“¶é¢ˆã€‚


## ğŸ§© æŠ€æœ¯æ ˆ (Tech Stack)

* **LLM Runtime**: Ollama (Running Qwen2.5-7B-Int4)
* **Framework**: LangChain & LangGraph
* **Vector DB**: ChromaDB
* **Embedding**: moka-ai/m3e-base (Optimized for Chinese/English semantic matching)
* **Reranker**: BAAI/bge-reranker-base
* **Retrieval Algorithm**: BM25 + Dense Vector Search (Hybrid)

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†ä»“åº“
git clone [https://github.com/YourName/IELTS-Tutor-RAG.git](https://github.com/YourName/IELTS-Tutor-RAG.git)
cd IELTS-Tutor-RAG

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

